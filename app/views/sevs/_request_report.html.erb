<%= form_with(model: @sevs, local: true,
    :html => { :onsubmit => 'formsubmit();' } ) do |f| %>

<br>

<div style="width: 50%; margin: 0 auto; text-align: center;">
  <p>
    This page produces reports that compare the symptoms that you are feeling with the known side effects of the drugs that you're taking.
  </p>
  <p>
    On the left, there is a box where you can add the symptoms that you're feeling to a list.
  </p>
  <p>
    On the right, you'll see a box where you can enter the names of the drugs that you're taking.  Right now, we only show generic names, so you'll need to know the generic (for instance, "lorazepam") instead of the brand name (which might be "Ativan").
  </p>
  <p>
    Clicking on the button that says "Generate Report" will show you the report and allow you to print or save it locally.
  </p>
</div>

<table border=0 style="text-align: center; width:100%">
  <tr>
    <td>Choose Symptoms from the drop-down below
    </td>
    <td>Choose Meds from the drop-down below
    </td>
  </tr>

<!-- ------------------------------------------------- -->

<script>

  function loadListOptions(listName) {
    if (typeof(Storage) !== "undefined") {
      var list = document.getElementById(listName);
      list.innerHTML = window.localStorage.getItem(listName);
    }
  }
  function list_options_change(listName) {
    if (typeof(Storage) !== "undefined") {
      var list = document.getElementById(listName);
      window.localStorage.setItem(listName, list.innerHTML);
    }
  }

  function list_add_from_to(fromListName, toListName) {
    var fromList = document.getElementById(fromListName);
    var fromListItem = fromList.options[fromList.selectedIndex];
    var option = document.createElement("option");
    option.id = fromListItem.value; // setting ID so we can use namedItem
    option.value = fromListItem.value;
    option.text = fromListItem.text;
    var list = document.getElementById(toListName);
    if (list.namedItem(option.value) == null) {
      list.add(option);
    }
    list_options_change(toListName);
    list.scrollTop = list.scrollHeight;
  }
  function list_remove_selected(listName) {
    var list = document.getElementById(listName);
    list.remove(list.selectedIndex);
    list_options_change(listName);
  }
  function list_remove_all(listName) {
    var list = document.getElementById(listName);
    list.innerHTML = '';
  }
  function list_select_all(listName) {
    var list = document.getElementById(listName);
    for(var i=0; i<list.options.length; i++) {
      list.options[i].selected = true;
    }
  }
  function onEnter(event, fromList, toList) {
    return event.charCode !== 13 ||
      list_add_from_to(fromList, toList);
  }
  function formsubmit() {
    list_select_all("drugList");
    list_select_all("symptomList");
  }

var drug_xhr = new XMLHttpRequest();
drug_xhr.onreadystatechange = function() {
  console.log("drug_xhr.onreadystatechange");
  if (drug_xhr.readyState === 4 && drug_xhr.status === 200) {
    console.log(drug_xhr.response);
  }
}
var symptom_xhr = new XMLHttpRequest();
symptom_xhr.onreadystatechange = function() {
  if (symptom_xhr.readyState === 4 && symptom_xhr.status === 200) {
    console.log(symptom_xhr.response);
  }
}

function onDrugKey(event, text) {
  if (text.length >= 2) {
    url = 'http://localhost:5375/check/drugs/' + text;
    drug_xhr.open('GET', url, true);
    drug_xhr.send();
    console.log("sent drug_xhr : " + url);
  }
}
function onSymptomKey(event, text) {
  if (text.length >= 2) {
    url = 'http://localhost:5375/check/symptoms/' + text;
    symptom_xhr.open('GET', url, true);
    symptom_xhr.send();
    console.log("sent symptom_xhr : " + url);
  }
}

</script>

  <tr>
    <td>
      <%= text_field_tag 'symptom-text', '',
          onkeyup: 'onSymptomKey(event, this.value);' %>
      <%= button_tag 'Add symptom to list',
          type: 'button',
          :onclick => 'list_add_from_to( "symptom-select", "symptomList" )' %>
    </td>
    <td>
      <%= text_field_tag 'drug-text', '',
          onkeyup: 'onDrugKey(event, this.value);' %>
      <%= button_tag 'Add drug to list',
          type: 'button',
          :onclick => 'list_add_from_to( "drug-select", "drugList" )' %>
    </td>
  </tr>
  <tr>
    <td>
      <%= select_tag "symptomList", "",
          :size => 5, :style => "width: 150px;", multiple: true,
          :ondblclick => 'list_remove_selected("symptomList")' %>
      <BR>
      <%= button_tag 'Remove',
          type: 'button',
          :onclick => 'list_remove_selected("symptomList")' %>
      <%= button_tag 'Clear',
          type: 'button',
          :onclick => 'list_remove_all("symptomList")' %>
    </td>
    <td>
      <%= select_tag "drugList", "",
          :size => 5, :style => "width: 150px;", multiple: true,
          :ondblclick => 'list_remove_selected("drugList")' %>
      <BR>
      <%= button_tag 'Remove',
          type: 'button',
          :onclick => 'list_remove_selected("drugList")' %>
      <%= button_tag 'Clear',
          type: 'button',
          :onclick => 'list_remove_all("drugList")' %>
    </td>
  </tr>
</table>

<div style="text-align: center">
    <%= f.submit "Generate Report", autofocus: true %>
</div>

<% end %>

<%= javascript_tag 'loadListOptions("drugList")' %>
<%= javascript_tag 'loadListOptions("symptomList")' %>
